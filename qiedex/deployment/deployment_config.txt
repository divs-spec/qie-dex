# ==================== DOCKER COMPOSE ====================
# docker-compose.yml
version: '3.8'

services:
  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_API_URL=http://api:3001
      - REACT_APP_WS_URL=ws://websocket:8080
    depends_on:
      - api
      - websocket
    networks:
      - qie-network

  # Backend API
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    environment:
      - MONGODB_URI=mongodb://mongodb:27017/qie_dex
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - QIE_RPC_URL=https://rpc.testnet.qie.digital
      - NODE_ENV=production
    depends_on:
      - mongodb
      - redis
    networks:
      - qie-network
    restart: unless-stopped

  # WebSocket Server
  websocket:
    build:
      context: ./websocket
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
      - "3002:3002"
    environment:
      - QIE_RPC_URL=https://rpc.testnet.qie.digital
      - EXECUTOR_PRIVATE_KEY=${EXECUTOR_PRIVATE_KEY}
      - NODE_ENV=production
    networks:
      - qie-network
    restart: unless-stopped

  # MongoDB
  mongodb:
    image: mongo:6.0
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - ./mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    environment:
      - MONGO_INITDB_DATABASE=qie_dex
    networks:
      - qie-network
    restart: unless-stopped

  # Redis
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    networks:
      - qie-network
    restart: unless-stopped

  # Nginx (Reverse Proxy)
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - frontend
      - api
      - websocket
    networks:
      - qie-network
    restart: unless-stopped

networks:
  qie-network:
    driver: bridge

volumes:
  mongodb_data:
  redis_data:

---

# ==================== FRONTEND DOCKERFILE ====================
# frontend/Dockerfile
FROM node:18-alpine AS build

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/build /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 3000

CMD ["nginx", "-g", "daemon off;"]

---

# ==================== BACKEND DOCKERFILE ====================
# backend/Dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 3001

CMD ["node", "server.js"]

---

# ==================== WEBSOCKET DOCKERFILE ====================
# websocket/Dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 8080 3002

CMD ["node", "websocket-server.js"]

---

# ==================== NGINX CONFIGURATION ====================
# nginx/nginx.conf
events {
    worker_connections 1024;
}

http {
    upstream frontend {
        server frontend:3000;
    }

    upstream api {
        server api:3001;
    }

    upstream websocket {
        server websocket:8080;
    }

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=ws_limit:10m rate=5r/s;

    server {
        listen 80;
        server_name qiedex.com www.qiedex.com;

        # Redirect to HTTPS
        return 301 https://$server_name$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name qiedex.com www.qiedex.com;

        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;

        # Security headers
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;

        # Frontend
        location / {
            proxy_pass http://frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }

        # API
        location /api/ {
            limit_req zone=api_limit burst=20 nodelay;
            
            proxy_pass http://api/api/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # CORS headers
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;
        }

        # WebSocket
        location /ws/ {
            limit_req zone=ws_limit burst=10 nodelay;
            
            proxy_pass http://websocket/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_read_timeout 86400;
        }
    }
}

---

# ==================== GITHUB ACTIONS CI/CD ====================
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test
      
      - name: Run linter
        run: npm run lint
      
      - name: Build
        run: npm run build

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push Docker images
        run: |
          docker-compose build
          docker-compose push
      
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/qie-dex
            git pull origin main
            docker-compose pull
            docker-compose up -d
            docker system prune -f

---

# ==================== ENVIRONMENT VARIABLES ====================
# .env.example
# Copy this to .env and fill in your values

# Backend
NODE_ENV=production
PORT=3001

# Database
MONGODB_URI=mongodb://localhost:27017/qie_dex
REDIS_HOST=localhost
REDIS_PORT=6379

# Blockchain
QIE_RPC_URL=https://rpc.testnet.qie.digital
QIE_CHAIN_ID=1729
EXECUTOR_PRIVATE_KEY=your_private_key_here

# Contracts
ROUTER_CONTRACT=0x1234567890123456789012345678901234567890
AUDIT_REGISTRY_CONTRACT=0x2345678901234567890123456789012345678901
ORDER_BOOK_CONTRACT=0x3456789012345678901234567890123456789012

# API Keys
INFURA_API_KEY=your_infura_key
ALCHEMY_API_KEY=your_alchemy_key
ETHERSCAN_API_KEY=your_etherscan_key

# IPFS
IPFS_PROJECT_ID=your_ipfs_project_id
IPFS_PROJECT_SECRET=your_ipfs_secret

# Email (for notifications)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your_email@gmail.com
SMTP_PASS=your_app_password

# Security
JWT_SECRET=your_jwt_secret_here
ENCRYPTION_KEY=your_encryption_key_here

# Frontend URLs
FRONTEND_URL=https://qiedex.com
API_URL=https://api.qiedex.com
WS_URL=wss://ws.qiedex.com

# Analytics
GOOGLE_ANALYTICS_ID=UA-XXXXXXXXX-X
SENTRY_DSN=your_sentry_dsn

---

# ==================== PACKAGE.JSON (Root) ====================
{
  "name": "qie-dex-complete",
  "version": "1.0.0",
  "description": "Complete QIE DEX with all features",
  "private": true,
  "workspaces": [
    "frontend",
    "backend",
    "websocket",
    "contracts"
  ],
  "scripts": {
    "install:all": "npm install && npm run install:frontend && npm run install:backend && npm run install:ws",
    "install:frontend": "cd frontend && npm install",
    "install:backend": "cd backend && npm install",
    "install:ws": "cd websocket && npm install",
    "dev": "concurrently \"npm run dev:frontend\" \"npm run dev:backend\" \"npm run dev:ws\"",
    "dev:frontend": "cd frontend && npm start",
    "dev:backend": "cd backend && npm run dev",
    "dev:ws": "cd websocket && npm run dev",
    "build": "npm run build:frontend && npm run build:contracts",
    "build:frontend": "cd frontend && npm run build",
    "build:contracts": "cd contracts && npx hardhat compile",
    "test": "npm run test:backend && npm run test:contracts",
    "test:backend": "cd backend && npm test",
    "test:contracts": "cd contracts && npx hardhat test",
    "deploy:contracts": "cd contracts && npx hardhat run scripts/deploy.js --network qie_testnet",
    "lint": "eslint . --ext .js,.jsx",
    "lint:fix": "eslint . --ext .js,.jsx --fix",
    "docker:build": "docker-compose build",
    "docker:up": "docker-compose up -d",
    "docker:down": "docker-compose down",
    "docker:logs": "docker-compose logs -f"
  },
  "devDependencies": {
    "concurrently": "^8.0.0",
    "eslint": "^8.40.0",
    "eslint-config-airbnb": "^19.0.4",
    "eslint-plugin-import": "^2.27.5",
    "eslint-plugin-jsx-a11y": "^6.7.1",
    "eslint-plugin-react": "^7.32.2"
  }
}

---

# ==================== HARDHAT CONFIG ====================
# contracts/hardhat.config.js
require("@nomicfoundation/hardhat-toolbox");
require("dotenv").config();

module.exports = {
  solidity: {
    version: "0.8.19",
    settings: {
      optimizer: {
        enabled: true,
        runs: 200
      }
    }
  },
  networks: {
    hardhat: {
      chainId: 1337
    },
    qie_testnet: {
      url: process.env.QIE_RPC_URL || "https://rpc.testnet.qie.digital",
      accounts: [process.env.DEPLOYER_PRIVATE_KEY],
      chainId: 1729,
      gasPrice: 1000000000,
      gas: 5000000
    },
    qie_mainnet: {
      url: process.env.QIE_MAINNET_RPC_URL || "https://rpc.qie.digital",
      accounts: [process.env.DEPLOYER_PRIVATE_KEY],
      chainId: 1729,
      gasPrice: 1000000000
    }
  },
  etherscan: {
    apiKey: {
      qie_testnet: process.env.QIE_EXPLORER_API_KEY || "api-key"
    },
    customChains: [
      {
        network: "qie_testnet",
        chainId: 1729,
        urls: {
          apiURL: "https://api-testnet.qie.digital",
          browserURL: "https://testnet.qie.digital"
        }
      }
    ]
  },
  paths: {
    sources: "./contracts",
    tests: "./test",
    cache: "./cache",
    artifacts: "./artifacts"
  },
  mocha: {
    timeout: 40000
  }
};

---

# ==================== DEPLOYMENT SCRIPT ====================
# contracts/scripts/deploy.js
const hre = require("hardhat");

async function main() {
  console.log("Starting deployment to QIE network...");

  const [deployer] = await hre.ethers.getSigners();
  console.log("Deploying contracts with account:", deployer.address);

  const balance = await deployer.getBalance();
  console.log("Account balance:", hre.ethers.utils.formatEther(balance), "QIE");

  // Deploy WQIE
  console.log("\n1. Deploying WQIE...");
  const WQIE = await hre.ethers.getContractFactory("WQIE");
  const wqie = await WQIE.deploy();
  await wqie.deployed();
  console.log("WQIE deployed to:", wqie.address);

  // Deploy Factory (assuming you have one)
  console.log("\n2. Deploying Factory...");
  const Factory = await hre.ethers.getContractFactory("QIEFactory");
  const factory = await Factory.deploy(deployer.address);
  await factory.deployed();
  console.log("Factory deployed to:", factory.address);

  // Deploy Audit Registry
  console.log("\n3. Deploying Audit Registry...");
  const AuditRegistry = await hre.ethers.getContractFactory("QIEAuditRegistry");
  const auditRegistry = await AuditRegistry.deploy();
  await auditRegistry.deployed();
  console.log("Audit Registry deployed to:", auditRegistry.address);

  // Deploy Router
  console.log("\n4. Deploying Router...");
  const Router = await hre.ethers.getContractFactory("QIERouter");
  const router = await Router.deploy(factory.address, wqie.address, auditRegistry.address);
  await router.deployed();
  console.log("Router deployed to:", router.address);

  // Deploy Order Book
  console.log("\n5. Deploying Order Book...");
  const OrderBook = await hre.ethers.getContractFactory("QIEOrderBook");
  const orderBook = await OrderBook.deploy(router.address);
  await orderBook.deployed();
  console.log("Order Book deployed to:", orderBook.address);

  // Save addresses
  const addresses = {
    WQIE: wqie.address,
    Factory: factory.address,
    Router: router.address,
    AuditRegistry: auditRegistry.address,
    OrderBook: orderBook.address,
    deployer: deployer.address,
    network: hre.network.name,
    chainId: (await hre.ethers.provider.getNetwork()).chainId
  };

  const fs = require("fs");
  fs.writeFileSync(
    "./deployed-addresses.json",
    JSON.stringify(addresses, null, 2)
  );

  console.log("\nâœ… Deployment complete!");
  console.log("Addresses saved to deployed-addresses.json");
  
  console.log("\nðŸ“ Update your .env file with these addresses:");
  console.log(`ROUTER_CONTRACT=${router.address}`);
  console.log(`AUDIT_REGISTRY_CONTRACT=${auditRegistry.address}`);
  console.log(`ORDER_BOOK_CONTRACT=${orderBook.address}`);
  console.log(`WQIE_CONTRACT=${wqie.address}`);

  // Verify contracts on explorer
  if (hre.network.name !== "hardhat" && hre.network.name !== "localhost") {
    console.log("\nâ³ Waiting for block confirmations...");
    await router.deployTransaction.wait(6);

    console.log("\nðŸ” Verifying contracts on explorer...");
    try {
      await hre.run("verify:verify", {
        address: wqie.address,
        constructorArguments: []
      });
      await hre.run("verify:verify", {
        address: router.address,
        constructorArguments: [factory.address, wqie.address, auditRegistry.address]
      });
      await hre.run("verify:verify", {
        address: auditRegistry.address,
        constructorArguments: []
      });
      await hre.run("verify:verify", {
        address: orderBook.address,
        constructorArguments: [router.address]
      });
      console.log("âœ… Contracts verified!");
    } catch (error) {
      console.error("Verification error:", error);
    }
  }
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });

---

# ==================== KUBERNETES DEPLOYMENT ====================
# k8s/deployment.yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: qie-dex-frontend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: qie-dex-frontend
  template:
    metadata:
      labels:
        app: qie-dex-frontend
    spec:
      containers:
      - name: frontend
        image: qie-dex/frontend:latest
        ports:
        - containerPort: 3000
        resources:
          limits:
            memory: "512Mi"
            cpu: "500m"
          requests:
            memory: "256Mi"
            cpu: "250m"
---
apiVersion: v1
kind: Service
metadata:
  name: qie-dex-frontend
spec:
  selector:
    app: qie-dex-frontend
  ports:
    - protocol: TCP
      port: 80
      targetPort: 3000
  type: LoadBalancer
